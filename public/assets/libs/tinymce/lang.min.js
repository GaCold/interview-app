function googleTranslateElementInit() {
    new google.translate.TranslateElement({
        layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL
    }, 'google_translate_element');
}

function toObject(text) {
    let obj = {};
    for (let [, key, val] of text.matchAll(/(\S.*?)=([^]*?)(?=$|\n\S)/g)) {
        obj[key] = val.replace(/\n /g, "\n"); /* remove the indent */
    }
    return obj;
}

var waitForEl = function(selector, callback) {
    if (jQuery(selector).length) {
        callback();
    } else {
        setTimeout(function() {
        waitForEl(selector, callback);
        }, 100);
    }
};
var countries = JSON.parse($('#p-lang-countries').text())

async function getLocateFromIp() {
    /* Get country from ip */
    return await $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
        var object = toObject(data)
        var locale = object.loc
        if(locale){
            $.each(countries, function( index, value ) {
                var c = value.countries
                if(c && c.includes(locale.toLowerCase())){
                    return value.code
                }
            })
        }
        return 'en'
    })
}

/* Set language translate first load page */
var first_loading = $('#p-first-loading').text()
// set localstorage data from server when cookies timeout
if(first_loading == 'true'){
    localStorage.setItem('lang_locale', $('#p-lang-locale').text().trim())
    localStorage.setItem('lang_name', $('#p-lang-name-locale').text())
    localStorage.setItem('img_locale', $('#p-img-locale').text())
}
var lang_locale = localStorage.getItem('lang_locale')
var lang_name= localStorage.getItem('lang_name')
var img_locale= localStorage.getItem('img_locale')
var languageSelect = document.querySelector("select.goog-te-combo");
var force_default_language = $('#d-language').text()
var do_translate = $('#p-do-translate').text()
var domain = $('#p-domain').text()
var href = ""

if(!lang_name){
    lang_name = $('#p-lang-name-locale').text()
}
if(!img_locale){
    img_locale = $('#p-img-locale').text()
}
if(!lang_locale){
    lang_locale = $('#p-lang-locale').text().trim()
}
if(do_translate == 'true'){
    waitForEl("select.goog-te-combo option", function() {
        var languageSelect = document.querySelector("select.goog-te-combo")
        languageSelect.value = lang_locale;
        languageSelect.dispatchEvent(new Event("change"));
    });
}

$('.lang-select option[value="'+lang_locale+'"]').attr('selected', 'selected')
$('.lang-name').text(lang_name)
$('.img-locale').attr('src', img_locale)


/* Event select dropdown language */
$('.lang-select').on('click', function() {
    lang_locale = $(this).attr('data-lang');
    lang_name = $(this).attr('data-lang-name')
    var href = $(this).attr('href')
    if(href != 'javascript:void(0)'){
        /* Restore old language */
        $('#\\:1\\.container').contents().find('#\\:1\\.restore').click();
        window.location.href = href
    }else{
        if(lang_locale){
            languageSelect = document.querySelector("select.goog-te-combo");
            languageSelect.value = lang_locale;
            languageSelect.dispatchEvent(new Event("change"));

            setCookie('locale', lang_locale, (30 * 3600 * 1000))
            setCookie('lang_name', lang_name, (30 * 3600 * 1000))
            setCookie('first_loading', 'false', (30 * 3600 * 1000))
            setCookie('do_translate', 'true', (30 * 3600 * 1000))
        }
    }
    /* set flag */
    var logo = $(this).find('img').attr('src')
    if(logo  && lang_locale  && lang_name){
        localStorage.setItem('img_locale', logo)
        localStorage.setItem('lang_locale', lang_locale)
        localStorage.setItem('lang_name', lang_name)
        $('.img-locale').attr('src', logo)
        $('.lang-name').text(lang_name)
    }
});

/* Clear storage language when logout */
$('.l-log-out').on('click', function(e){
    e.preventDefault()
    localStorage.setItem('lang_locale', '')
    window.location.href = $(this).attr('href')
})

/* Set cookie */
function setCookie(c_name, value, times) {
    var time = new Date();
    time.setTime(time.getTime() + (times))
    var c_value = escape(value) + ((times == null) ? "" : "; expires=" + time.toUTCString() + "; path=/;domain=." + domain);
    document.cookie = c_name + "=" + c_value;
}

function getCookie(c_name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) {
            return unescape(y);
        }
    }
}

$('.currency .dropdown').on('click', function(){
    $('.language-mobile .dropdown').removeClass('show')
})
$('.language .dropdown').on('click', function(){
    $('.currency-mobile .dropdown').removeClass('show')
})
$('.language .dropdown .lang-select').on('click', function(){
    $('.language-mobile .dropdown').removeClass('show')
})
